<script>
  const frases = {};
  const tabla = document.getElementById("tabla");
  const audioInput = document.getElementById("audioInput");
  const nombreSonido = document.getElementById("nombreSonido");
  let recognition; // importante declararlo afuera
  let escuchando = false; // para evitar loops dobles

  document.getElementById("btnMP3").onclick = () => audioInput.click();

  audioInput.onchange = () => {
    const file = audioInput.files[0];
    nombreSonido.value = file ? file.name : "NingÃºn archivo";
  };

  document.getElementById("agregarBtn").onclick = () => {
    const frase = document.getElementById("frase").value.trim().toLowerCase();
    const file = audioInput.files[0];

    if (!frase || !file) return alert("Completa la frase y el sonido.");

    frases[frase] = URL.createObjectURL(file);
    tabla.innerHTML += `<tr><td>${frase}</td><td>${file.name}</td></tr>`;

    document.getElementById("frase").value = "";
    audioInput.value = "";
    nombreSonido.value = "NingÃºn archivo";
  };

  document.getElementById("startBtn").onclick = () => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return alert("Tu navegador no soporta reconocimiento de voz.");

    if (escuchando) return; // evitar iniciar 2 veces
    escuchando = true;

    recognition = new SpeechRecognition();
    recognition.lang = "es-ES";
    recognition.continuous = false; // igual lo forzamos a reiniciar
    recognition.interimResults = false;

    recognition.onstart = () => status.textContent = "ğŸ™ï¸ Escuchando sin parar...";

    recognition.onresult = event => {
      const dicho = event.results[0][0].transcript.toLowerCase();
      status.textContent = `Dijiste: "${dicho}"`;

      for (const key in frases) {
        if (dicho.includes(key)) {
          new Audio(frases[key]).play();
          status.textContent += " | ğŸ”Š Reproduciendo...";
        }
      }
    };

    recognition.onerror = () => {
      status.textContent = "âš ï¸ Error, reiniciando...";
    };

    // â¤ï¸ El truco mÃ¡gico:
    recognition.onend = () => {
      if (!escuchando) return;
      status.textContent = "ğŸ™ï¸ Escuchando...";
      recognition.start(); // reinicia siempre
    };

    recognition.start();
  };
</script>
