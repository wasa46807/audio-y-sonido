<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capcom Voice Trigger</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        #downloadLink {
            display: none;
            margin-top: 10px;
        }
        .fraseBox {
            margin-top: 25px;
        }
        .fraseItem {
            background:#eee;
            padding:8px;
            margin-top:5px;
            border-radius:6px;
            font-weight:bold;
        }
        #micStatus{
            font-weight:bold;
            color:green;
            margin-left:10px;
        }
    </style>
</head>
<body>

    <h2>Cargar MP3</h2>

    <!-- Subir MP3 -->
    <input type="file" id="audioInput" accept="audio/mp3, audio/mpeg">

    <br><br>

    <!-- Reproductor -->
    <audio id="player" controls></audio>

    <!-- Bot贸n para descargar -->
    <br>
    <a id="downloadLink">猬锔 Descargar MP3</a>

    <hr>

    <!-- Micr贸fono -->
    <button id="activarMic"> Activar micr贸fono</button>
    <span id="micStatus"></span>

    <hr>

    <div class="fraseBox">
        <h3>Agregar frase</h3>
        <input type="text" id="fraseInput" placeholder="Escribe tu frase..." size="40">
        <button id="agregarFrase">Agregar</button>

        <div id="listaFrases"></div>
    </div>

    <script>
        // === AUDIO ===
        const audioInput = document.getElementById("audioInput");
        const player = document.getElementById("player");
        const downloadLink = document.getElementById("downloadLink");

        audioInput.addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            player.src = url;

            downloadLink.href = url;
            downloadLink.download = file.name;
            downloadLink.style.display = "inline-block";
        });

        // === FRASES ===
        const fraseInput = document.getElementById("fraseInput");
        const agregarFrase = document.getElementById("agregarFrase");
        const listaFrases = document.getElementById("listaFrases");

        agregarFrase.addEventListener("click", () => {
            const texto = fraseInput.value.trim();
            if (texto === "") return;

            const div = document.createElement("div");
            div.className = "fraseItem";
            div.textContent = texto;

            listaFrases.appendChild(div);
            fraseInput.value = "";
        });

        // === MICRFONO CONTINUO ===
        const activarMic = document.getElementById("activarMic");
        const micStatus = document.getElementById("micStatus");

        let recognition;
        let escuchando = false;

        activarMic.addEventListener("click", () => {
            if (escuchando) return;

            recognition = new(window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = "es-ES";
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onstart = () => {
                escuchando = true;
                micStatus.textContent = "Micr贸fono activo";
            };

            recognition.onresult = (event) => {
                let texto = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();

                const frases = Array.from(document.querySelectorAll('.fraseItem')).map(e=>e.textContent.toLowerCase());
                let index = frases.indexOf(texto);

                if(index >= 0){
                    player.currentTime = 0;
                    player.play();
                }
            };

            recognition.onend = () => {
                // auto-reiniciar para que NUNCA se apague
                recognition.start();
            };

            recognition.start();
        });

    </script>

</body>
</html>
