<script>
  const frases = {};
  const tabla = document.getElementById("tabla");
  const audioInput = document.getElementById("audioInput");
  const nombreSonido = document.getElementById("nombreSonido");

  let recognition;
  let escuchando = false;

  // Seleccionar archivo
  document.getElementById("btnMP3").onclick = () => audioInput.click();

  audioInput.onchange = () => {
    const file = audioInput.files[0];
    nombreSonido.value = file ? file.name : "NingÃºn archivo seleccionado";
  };

  // Agregar frase + audio
  document.getElementById("agregarBtn").onclick = () => {
    const frase = document.getElementById("frase").value.trim().toLowerCase();
    const file = audioInput.files[0];

    if (!frase || !file) return alert("Debes poner frase y sonido.");

    frases[frase] = URL.createObjectURL(file);

    tabla.innerHTML += `<tr><td>${frase}</td><td>${file.name}</td></tr>`;

    document.getElementById("frase").value = "";
    audioInput.value = "";
    nombreSonido.value = "NingÃºn archivo seleccionado";
  };

  // Activar modo escucha infinita
  document.getElementById("startBtn").onclick = () => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return alert("Tu navegador no soporta reconocimiento de voz.");

    if (escuchando) return; // Evitar doble inicio
    escuchando = true;

    recognition = new SpeechRecognition();
    recognition.lang = "es-ES";
    recognition.continuous = false; // Igual lo forzamos a reiniciar
    recognition.interimResults = false;

    recognition.onstart = () => {
      status.textContent = "ğŸ™ï¸ Escuchando continuamente...";
    };

    recognition.onresult = e => {
      const dicho = e.results[0][0].transcript.toLowerCase();
      status.textContent = `Dijiste: "${dicho}"`;

      // Buscar frase y reproducir audio
      for (const key in frases) {
        if (dicho.includes(key)) {
          const audio = new Audio(frases[key]);
          audio.play();
          status.textContent += " | ğŸ”Š Reproduciendo...";
        }
      }
    };

    recognition.onerror = () => {
      status.textContent = "âš ï¸ Error. Reiniciando...";
    };

    // El truco para que nunca se apague
    recognition.onend = () => {
      if (!escuchando) return;
      status.textContent = "ğŸ™ï¸ Escuchando...";
      recognition.start(); // Reanudar SIEMPRE
    };

    recognition.start();
  };
</script>
