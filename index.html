<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capcom Voice Trigger</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        #downloadLink {
            display: none;
            margin-top: 10px;
        }
        .fraseBox {
            margin-top: 25px;
        }
        .fraseItem {
            background:#eee;
            padding:8px;
            margin-top:5px;
            border-radius:6px;
            font-weight:bold;
        }
    </style>
</head>
<body>

    <h2 style="color:#2c3e50;">üéõÔ∏è Panel de Control</h2>

    <div style="display:flex; gap:20px;">

        <!-- CUADRADO BLANCO PRINCIPAL -->
        <div style="background:#ffffff; padding:20px; width:350px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,0.1);">

            <h3>üìù Frase</h3>
            <input type="text" id="fraseInput" placeholder="Escribe tu frase..." style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
            <br><br>

            <h3>üéµ Audio (MP3)</h3>
            <button id="btnMP3" style="padding:10px; width:100%; border:none; border-radius:6px; background:#3498db; color:white; cursor:pointer;">Subir MP3</button>
            <input type="file" id="audioInput" accept="audio/mp3,audio/mpeg" style="display:none;">
            <p id="nombreArchivo" style="margin-top:10px; color:#555;">Ning√∫n archivo seleccionado</p>

            <br>
            <button id="agregarBtn" style="padding:10px; width:100%; background:#27ae60; color:white; border:none; border-radius:6px; cursor:pointer;">Agregar</button>
        </div>

        <!-- LISTA -->
        <div style="flex:1; background:#f5f5f5; padding:20px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,0.1);">
            <h3>üìã Frases y sonidos</h3>
            <table id="tabla" style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="background:#ddd;">
                        <th style="padding:8px; border:1px solid #bbb;">Frase</th>
                        <th style="padding:8px; border:1px solid #bbb;">Sonido</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <br>
    <button id="startBtn" style="padding:12px 20px; font-size:16px; background:#e67e22; border:none; color:white; border-radius:8px; cursor:pointer;">üéôÔ∏è Activar micr√≥fono</button>
    <p id="status" style="font-weight:bold; margin-top:15px;">Micr√≥fono apagado.</p>


<script>
    // ELEMENTOS
    const btnMP3 = document.getElementById("btnMP3");
    const audioInput = document.getElementById("audioInput");
    const nombreArchivo = document.getElementById("nombreArchivo");
    const agregarBtn = document.getElementById("agregarBtn");
    const tabla = document.querySelector("#tabla tbody");
    const startBtn = document.getElementById("startBtn");
    const status = document.getElementById("status");

    const frases = {};

    // BOT√ìN MP3
    btnMP3.onclick = () => audioInput.click();

    audioInput.onchange = () => {
        const file = audioInput.files[0];
        nombreArchivo.textContent = file ? file.name : "Ning√∫n archivo seleccionado";
    };

    // AGREGAR
    agregarBtn.onclick = () => {
        const frase = document.getElementById("fraseInput").value.trim().toLowerCase();
        const file = audioInput.files[0];

        if (!frase || !file) {
            alert("Escribe una frase y selecciona un MP3.");
            return;
        }

        const url = URL.createObjectURL(file);
        frases[frase] = url;

        const tr = document.createElement("tr");
        tr.innerHTML = `<td style='border:1px solid #bbb; padding:8px;'>${frase}</td>
                        <td style='border:1px solid #bbb; padding:8px;'>${file.name}</td>`;
        tabla.appendChild(tr);

        document.getElementById("fraseInput").value = "";
        audioInput.value = "";
        nombreArchivo.textContent = "Ning√∫n archivo seleccionado";
    };

    // MICR√ìFONO
    startBtn.onclick = () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("Tu navegador no soporta reconocimiento de voz.");
            return;
        }

        const rec = new SpeechRecognition();
        rec.lang = "es-ES";
        rec.continuous = true;

        rec.onstart = () => status.textContent = "üéôÔ∏è Escuchando...";
        rec.onresult = e => {
            const contenido = e.results[e.resultIndex][0].transcript.toLowerCase();
            status.textContent = `Dijiste: ${contenido}`;

            for (const f in frases) {
                if (contenido.includes(f)) {
                    new Audio(frases[f]).play();
                }
            }
        };

        rec.onerror = () => status.textContent = "‚ùå Error";

        rec.start();
    };
        
        // === MICROFONO (grabaci√≥n continua) ===
        const micBtn = document.createElement('button');
        micBtn.id = 'micBtn';
        micBtn.textContent = 'üé§ Activar micr√≥fono';
        document.body.insertBefore(micBtn, document.body.children[3]);

        const micStatus = document.createElement('div');
        micStatus.id = 'micStatus';
        micStatus.style.marginTop = '5px';
        document.body.insertBefore(micStatus, document.body.children[4]);

        let mediaRecorder;
        let chunks = [];
        let isRecording = false;

        micBtn.addEventListener('click', async () => {
            if (!isRecording) {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = e => {
                    chunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/mp3' });
                    chunks = [];
                    const url = URL.createObjectURL(blob);
                    const div = document.createElement('div');
                    div.className = 'fraseItem';
                    div.textContent = 'üé§ Frase grabada (mic)';
                    listaFrases.appendChild(div);

                    // Reiniciar grabaci√≥n autom√°ticamente
                    mediaRecorder.start();
                };

                mediaRecorder.start();
                micStatus.textContent = 'Grabando (continuo)...';
                micBtn.textContent = 'Micr√≥fono activo';
                isRecording = true;
            }
        });

// === MICR√ìFONO CONTINUO ===
let micStream;
let mediaRecorder;
let escuchando = false;

async function iniciarMicrofono() {
    if (escuchando) return; // ya est√° encendido
    escuchando = true;

    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(micStream);

    mediaRecorder.ondataavailable = (e) => {
        // No guardamos frases, solo dejamos que escuche continuo
    };

    mediaRecorder.start();
}

// Activamos el micr√≥fono autom√°ticamente cuando empieza cualquier reproducci√≥n
player.addEventListener("play", () => {
    iniciarMicrofono();
});

// Cuando termine el audio, el micr√≥fono sigue encendido, no se toca nada

</script>

</body>
</html>
